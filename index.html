<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ„æºåˆ†äº«ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒŸ èµ„æºåˆ†äº«ä¸­å¿ƒ</h1>
            <p>ç²¾é€‰ä¼˜è´¨èµ„æºï¼Œå®‰å…¨å¿«é€Ÿä¸‹è½½</p>
        </div>

        <div class="resources" id="resourcesList">
            <div class="resource-item" onclick="openPasswordModal('resource1')">
                <div class="resource-title">ğŸ“± æ‰‹æœºåº”ç”¨åˆé›†</div>
                <div class="resource-desc">åŒ…å«å„ç±»å®ç”¨æ‰‹æœºåº”ç”¨ï¼Œå·²å»å¹¿å‘Šä¼˜åŒ–ç‰ˆæœ¬</div>
                <div class="resource-info">
                    <span class="resource-size">å¤§å°: 2.3 GB</span>
                    <span class="resource-date">æ›´æ–°: 2024-05-28</span>
                </div>
            </div>

            <div class="resource-item" onclick="openPasswordModal('resource2')">
                <div class="resource-title">ğŸ¬ é«˜æ¸…ç”µå½±èµ„æº</div>
                <div class="resource-desc">æœ€æ–°çƒ­é—¨ç”µå½±ï¼Œ4Kè“å…‰åŸç›˜è´¨é‡</div>
                <div class="resource-info">
                    <span class="resource-size">å¤§å°: 15.6 GB</span>
                    <span class="resource-date">æ›´æ–°: 2024-05-27</span>
                </div>
            </div>

            <div class="resource-item" onclick="openPasswordModal('resource3')">
                <div class="resource-title">ğŸ“š å­¦ä¹ èµ„æ–™åŒ…</div>
                <div class="resource-desc">ç¼–ç¨‹ã€è®¾è®¡ã€è¯­è¨€å­¦ä¹ ç­‰å„ç±»æ•™ç¨‹èµ„æ–™</div>
                <div class="resource-info">
                    <span class="resource-size">å¤§å°: 8.9 GB</span>
                    <span class="resource-date">æ›´æ–°: 2024-05-26</span>
                </div>
            </div>

            <div class="resource-item" onclick="openPasswordModal('resource4')">
                <div class="resource-title">ğŸµ æ— æŸéŸ³ä¹ä¸“è¾‘</div>
                <div class="resource-desc">FLACæ ¼å¼æ— æŸéŸ³è´¨ï¼Œæ¶µç›–å„ç§éŸ³ä¹é£æ ¼</div>
                <div class="resource-info">
                    <span class="resource-size">å¤§å°: 12.4 GB</span>
                    <span class="resource-date">æ›´æ–°: 2024-05-25</span>
                </div>
            </div>

            <div class="resource-item" onclick="openPasswordModal('resource5')">
                <div class="resource-title">ğŸ’» åŠå…¬è½¯ä»¶å¥—è£…</div>
                <div class="resource-desc">Adobeå…¨å®¶æ¡¶ã€Officeå¥—ä»¶ç­‰ä¸“ä¸šè½¯ä»¶</div>
                <div class="resource-info">
                    <span class="resource-size">å¤§å°: 6.7 GB</span>
                    <span class="resource-date">æ›´æ–°: 2024-05-24</span>
                </div>
            </div>
        </div>

        <div class="message-board">
            <div class="message-header">
                <h2>ğŸ’¬ èµ„æºç•™è¨€æ¿</h2>
                <p>éœ€è¦ä»€ä¹ˆèµ„æºï¼Ÿåœ¨è¿™é‡Œå‘Šè¯‰æˆ‘ä»¬å§ï¼</p>
            </div>

            <div class="message-form">
                <div class="form-group">
                    <input type="text" id="userName" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„æ˜µç§°" required>
                </div>
                <div class="form-group">
                    <textarea id="userMessage" class="form-textarea" placeholder="è¯·æè¿°æ‚¨éœ€è¦çš„èµ„æºç±»å‹ã€åç§°ç­‰è¯¦ç»†ä¿¡æ¯..." rows="4" required></textarea>
                </div>
                <button class="btn btn-gradient" id="submitUserMessageBtn">
                    <span>ğŸ“ æäº¤ç•™è¨€</span>
                </button>
            </div>

            <div class="messages-list">
                <h3>ğŸ“‹ æœ€æ–°ç•™è¨€</h3>
                <div id="firebase-messages-list">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ğŸ“§ å¦‚æœ‰é—®é¢˜è¯·è”ç³»ç®¡ç†å‘˜ | ğŸ”’ æ‰€æœ‰èµ„æºå‡ç»è¿‡å®‰å…¨æ£€æµ‹</p>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ” è¯·è¾“å…¥è®¿é—®å¯†ç </h3>
            </div>
            <div class="modal-body">
                <input type="password" id="passwordInput" class="password-input" placeholder="è¯·è¾“å…¥4ä½æ•°å­—å¯†ç " maxlength="4">
                <div class="error-message" id="errorMessage">å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥</div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="verifyPassword()">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>

    <div id="successPage" class="modal">
        <div class="modal-content">
            <div class="success-page">
                <div class="success-icon">âœ…</div>
                <h3>å¯†ç æ­£ç¡®ï¼</h3>
                <p>ä»¥ä¸‹æ˜¯æ‚¨çš„ä¸‹è½½é“¾æ¥ï¼š</p>
                <div class="download-links" id="downloadLinks">
                </div>
                <button class="btn btn-primary" onclick="closeSuccessPage()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Load Firebase configuration from external file -->
    <script src="firebase-config.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        // Import Cloud Firestore SDK
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Firebase configuration is now loaded from firebase-config.js
        // and available as a global variable `firebaseConfig`

        // Initialize Firebase
        // firebaseConfig should be defined globally by firebase-config.js
        if (typeof firebaseConfig === 'undefined') {
            console.error("Firebase config is not loaded. Make sure firebase-config.js is present and loaded correctly.");
            alert("Firebaseé…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
        }
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Initialize Firestore

        const userNameInput = document.getElementById('userName');
        const userMessageInput = document.getElementById('userMessage');
        const submitUserMessageButton = document.getElementById('submitUserMessageBtn');
        const messagesDisplayArea = document.getElementById('firebase-messages-list');

        // Handle submitting new messages
        submitUserMessageButton.addEventListener('click', async () => {
            const author = userNameInput.value.trim();
            const message = userMessageInput.value.trim();

            if (author === '' || message === '') {
                alert('æ˜µç§°å’Œç•™è¨€å†…å®¹éƒ½ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            try {
                // Add message to 'siteMessages' collection (or 'messages' if you prefer)
                await addDoc(collection(db, "siteMessages"), { // Using "siteMessages" to distinguish from test.html's "messages"
                    author: author,
                    content: message,
                    timestamp: serverTimestamp() // Use server timestamp
                });
                // console.log("ç•™è¨€å·²æˆåŠŸæäº¤ï¼"); // You can uncomment for debugging
                alert("ç•™è¨€å·²æˆåŠŸæäº¤ï¼");
                userNameInput.value = ''; // Clear input fields
                userMessageInput.value = ''; // Clear input fields
            } catch (e) {
                console.error("æäº¤ç•™è¨€æ—¶å‘ç”Ÿé”™è¯¯: ", e);
                alert("æäº¤ç•™è¨€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚");
            }
        });

        // Listen for real-time message updates
        const q = query(collection(db, "siteMessages"), orderBy("timestamp", "desc")); // Order by timestamp descending

        onSnapshot(q, (snapshot) => {
            messagesDisplayArea.innerHTML = ''; // Clear existing messages
            if (snapshot.empty) {
                messagesDisplayArea.innerHTML = '<p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡å§ï¼</p>';
                return;
            }

            snapshot.forEach((doc) => {
                const messageData = doc.data();
                const messageItem = document.createElement('div');
                messageItem.classList.add('message-item');

                // Format timestamp to be more like the original static style
                const timestamp = messageData.timestamp ? 
                                  new Date(messageData.timestamp.toDate()).toLocaleString('zh-CN', {
                                      year: 'numeric', month: '2-digit', day: '2-digit', 
                                      hour: '2-digit', minute: '2-digit'
                                  }) : 'æœªçŸ¥æ—¶é—´';
                
                // Using the structure from index.html's original message items
                messageItem.innerHTML = `
                    <div class="message-meta">
                        <span class="message-author">ğŸ‘¤ ${messageData.author}</span>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="message-content">${messageData.content}</div>
                `;
                // Note: Admin replies would require a more complex data structure and UI in Firebase
                messagesDisplayArea.appendChild(messageItem);
            });
        }, (error) => {
            console.error("ç›‘å¬ç•™è¨€æ—¶å‘ç”Ÿé”™è¯¯: ", error);
            messagesDisplayArea.innerHTML = '<p>åŠ è½½ç•™è¨€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æ§åˆ¶å°é”™è¯¯ã€‚</p>';
        });
    </script>

    <script src="script.js"></script>
</body>
</html>